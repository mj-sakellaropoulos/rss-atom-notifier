# rss-atom-notifier

> ‚ÑπÔ∏è As of right now (06/06/2025), everything in this repo was generated by ChatGPT-4o.
> The code is functional, although only a small subset of the features have been tested. There are likely bugs and inconsistencies.
> This was an experiment, I will re-write it in the future with wider support by using some kind of standard rule parsing (sigma rules?)

A Go daemon that monitors RSS feeds (e.g. Reddit) and performs flexible, layered matching of entries based on YAML-configured rules. Matching entries can trigger notifications via stdout, Gotify, or custom HTTP endpoints.

---

## üîß Features

- Watches any RSS feed (tested with Reddit Atom feeds).
- Stores entries in SQLite with full metadata (author, title, published, updated, post URL, etc).
- Live-reloads YAML config (rules, outputs, etc).
- Supports advanced rule matching:
    - `stringContains`
    - `regex`
    - `regex_named_capture` (with named group extraction)
    - `string_distance` (Levenshtein-based fuzzy matching)
    - Chaining via `ref`, `targetRef`, `targetCaptureGroup`
- Structured match notifications:
    - To console (stdout)
    - Gotify server (via token)
    - Custom HTTP POST with Go templating

---

## üöÄ Usage

```bash
go run main.go -config=rules.yaml
```

Or build binary:

```bash
go build -o rssmatch
./rssmatch -config=rules.yaml
```

---

## üìÅ YAML Config (`rules.yaml`)

### Top-Level Structure

```yaml
apiVersion: v1alpha1
loglevel: debug

http:
  userAgent: "MyRSSBot/1.0"
  pollingIntervalMs: 60000
  rss_url: "https://old.reddit.com/r/news/top/.rss"

rules:
  - ruleType: stringContains
    targetFields: ["title"]
    pattern: "example"
    ref: "simple_match"

match_outputs:
  - stdout: {}
  - gotify:
      url: "http://localhost/message"
      token: "my-app-token"
  - http:
      method: POST
      url: "http://example.local/someEndpoint"
      payload_tmpl: |
        {
          "title": "{{.Entry.Title}}",
          "url": "{{.Entry.Link.Href}}",
          "matched": "{{join .Matched \", \"}}",
          "published": "{{.Entry.Published}}"
        }
```

---

## üîç Rule Types

| Rule Type            | Description |
|----------------------|-------------|
| `stringContains`     | Simple substring match |
| `regex`              | Go-style regular expression |
| `regex_named_capture`| Extracts named groups into `.Groups` |
| `string_distance`    | Levenshtein distance ‚â§ `distanceThreshold` |

### Rule Chaining

Use `ref` to label the output of one rule, and `targetRef` or `targetCaptureGroup` to feed that value into another rule.

---

## üíæ Database

SQLite file: `entries.db`

Schema includes:
- `id`, `author`, `title`
- `published`, `updated`
- `status` (read/unread)
- `RulesMatched` (comma-separated)
- `RegexGroupsJSON`
- `PostURL`
- `CreatedAt`

---

## üêõ Debug Mode

Enable verbose debug logging via:
```yaml
loglevel: debug
```

Sends all internal logs to `stderr`. Match notifications (e.g., stdout) go to `stdout`, so you can pipe them.

---

## üì§ Notifications

### Gotify

```yaml
- gotify:
    url: "https://gotify.example.com/message"
    token: "app-token"
```

### HTTP POST with templating

```yaml
- http:
    method: POST
    url: "https://hooks.example.com/myhook"
    payload_tmpl: |
      {
        "title": "{{.Entry.Title}}",
        "matched": "{{join .Matched \", \"}}"
      }
```

Use `.Entry`, `.Groups`, `.Matched` in the template.

---

## üß™ Rules Example

```yaml
rules:
  # 1. stringContains: look for "Constitution" in titles
  - ruleType: stringContains
    targetFields: ["title"]
    pattern: "Constitution"
    ref: "contains_constitution"

  # 2. regex: match authors with "Fancy" in their name
  - ruleType: regex
    targetField: "author"
    pattern: "(?i)Fancy"
    ref: "fancy_author"

  # 3. chained regex on fancy author: ensure it's exactly 'FancyNewMe'
  - ruleType: regex
    targetRef: fancy_author
    pattern: "^/u/FancyNewMe$"
    ref: "exact_fancy_author"

  # 4. regex_named_capture: extract bill number like "S-218"
  - ruleType: regex_named_capture
    targetField: "title"
    pattern: "(?P<bill>S-\\d+)"
    ref: "bill_capture"

  # 5. regex on captured bill number: check if it's bill S-218 specifically
  - ruleType: regex
    targetCaptureGroup: bill
    pattern: "^S-218$"
    ref: "is_bill_218"

  # 6. string_distance: approximate match for headline about "Crown corporations"
  - ruleType: string_distance
    targetFields: ["title"]
    pattern: "Canada‚Äôs runaway Crown corporations"
    distanceThreshold: 6
    ref: "fuzzy_crown"
```

